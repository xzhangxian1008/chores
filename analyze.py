import os
from matplotlib import pyplot as plt

file = "bench_result"
query_num = 43
ch_results = []
tiup_tpch_results = {}

interval = [10, 50, 200, 500, 1000]

v1_data = [
"423 403 809 616 2283262 570456 599281 242769 456430 498128 332633 564478 588269 578298 511075 441625 557745 621339 572821 432793 402240 369917 381976 662498 645935 349438 306792 377279 379619 391887 733684 452949 413891 378242 433019 447464 321473 287442 101768 744604 659691 345665 396578 201999 148644 229312 144074 719809 507918 305377 345586 276041 182147 195912 134099 189918 193086 103146 116692 95801 231461 194965 121006 282770 687670 454412 888776 514790 557196 416449 300872 138698 248570 167549 94794 245712 45101 276112 116266 365044 679845 506306 333770 270315 205824 207651 165815 350758 711545 462893 382040 158929 155436 207206 142349 222920 179937 182937 168012 171131 226459 596970 526923 347322 330347 186632 126980 256705 175746 164016 214018 594150 580291 333748 329585 269298 267070 96290 175817 250689 111533 274592 99589 210863 494060 701501 462719 299768 182533 198960 173876 196018 142885 564770 498326 466668 331558 201515 192348 183612 145286 146117 192105 205006 218692 140094 286859 116802 226159 172944 136121 233710 129917 872796 577916 416860 192219 183677 226877 206388 278492 536809 521856 485911 384989 329554 167799 95850 222544 111270 149708 196093 9556 1232 383 841 573 162259 563789 639831 380043 384925 261159 241225 181562 223052 273593 623128 521888 472864 295460 79823 231849 128042 87986 238086 119677 156992 85777 171966 154401 522 540 138176 87660 159483 639378 613805 436679 382864 250242 184768 154668 238579 159168 164694 204130 173558 156333 234651 537365 607026 423679 111182 667 166466 169433 179666 143278 152451 105747 150845 179662 65831 176535 54241 154119 170953 210259 211971 201966 817342 418414 425179 290707 128861 202825 200488 156769 165207 319839 538753 398833 368414 253432 120821 143115 206764 89010 242201 121289 231726 134369 151911 185138 182868 139247 206370 136096 177973 439540 703984 392718 421718 182938 263674 124622 220232 161963 154177 332222 682860 494245 297838 157923 168296 161019 123197 240496 168123 278102 116066 97818 97770 263252 167900 170526 111452 259342 411904 561310 388547 321222 269335 146838 209196 65688 572 5702 1904 811 742 664 538 68347 98775 4562 1035 661 828 1043 603 182493 308775 533618 516451 162459 163936 171495 437 2000 332 6014 5798 529 809 897 678 870 601 29506 118651 641 898 753 515 422411 309829 78408 147288 719 1915 1747 10236 3484 663 861 162749 464330 216163 151473 203292 135710 190813 156816 128023 67764 40908 78708 428899 58318 509 763 1935 16510 7110 1220 2314 4428 3645 1194 1113 619 422175 262177 144213 196087 185432 180164 188442 166129 93661 726 176326 126273 682 734 2305 10693 27608 32240 6356 866 657 1145 777 673 376095 394585 171241 167156 214675 166024 94645 621 3356 10476 888 2031 375 4487 5166 6487 8865 11847 2307 5808 1839 1050 130681 265742 219802 137444 199884 217426 152102 174741 219264 100073 488168 91586 199787 33324 132599 65959 474 444 688 775 355 806 110859 71905 120562 344 2556 2523 351 612 334 908 2193 7758 2604 1869 606 4598 8015 7440 4258 2145 783 963 739 1323 776 846 614 631 1022 1291 677 744 505 1008 3886 6004 9220 1278 7972 3562 1436 595 799 343 665 605 432 888 539831 639044 536484 456581 459638 390885 485961 330873 734613 576938 756881 358721 620397 557554 523535 353642 515580 422187 484362 631667 554870 798170 409191 446499 605265 444024 607759 434198 479579 624973 370663 512936 440222 519155 359470 347908 168199 708376 780109 472243 516474 367743 466216 370840 362355 373555 500263 566520 756310 700921 462168 292711 299495 307728 418415 299118 411844 689212 700094 628071 359167 405978 386689 325405 308718 192922 112834 150554 122786 46750 198529 56146 413456 738077 502795 505174 396017 246592 312830 389757 133401 130640 140800 385231 579246 594736 438932 365834 172903 164642 117871 161523 93613 125764 143598 108978 185512 70333 138115 154788 82744 167208 235964 49614 196070 178293 98157 196249 145648 95652 187061 99272"
, "84 571109 425848 536749 517388 481953 437852 425113 422996 264439 404553 195623 148037 348165 535616 179065 296474 304773 414610 177368 185695 397639 187493 421414 180280 356121 263571 373734 210864 180403 187777 446240 217531 451824 149434 41621 349299 258384 437387 153157 137763 77276 464594 180375 261208 261804 150115 125423 189854 416100 209026 336051 160476 177202 219845 393006 198643 360232 194187 148561 302907 267028 14935 33813 1626 308388 100065 2696 6510 24291 191731 3609 199115 162931 134920 5365 2560 166059 183251 79534 14716 1960 221950 95864 3651 6934 81024 185332 214766 86429 613 61245 946 3006 5291 917 881 1364 5607 768 236160 465910 551605 514142 578252 502547 484470 366991 568989 414646 555726 347320 556504 265314 114953 511104 242644 427789 196554 131493 122637 151620 144776"
, "21 512773 441978 253163 339830 270612 296706 301072 257987 248045 246673 245863 181799 280413 247174 251472 79350 104415 104687 76444 110890 80856 122014 37308 2524 60975 527477 480749 468549 283504 219618"
, "8 448800 278543 275929 264264 233577 249111 95108 95206 89852 31618 500328 291631"
, "4 363671 270097 241344 95157 60735 395979"]

v2_data = [
"1272352 2927624 937619 277184 162016 233765 173005 365028 1329594 178228 228313 161270 257303 122606 263812 168591 146138 396227 1229788 207911 322737 190942 278370 158347 225223 188785 751718 1270731 778591 581588 1304789 1001786 283974 1033049 337860 167862 246674 107122 281011 207919 296630 176322 340095 150677 355599 351088 285007 580358 2218751 974091 368444 229260 234106 577366 227456 400695 114419 1900521 1084062 239273 218142 131819 236917 166865 206201 152648 193320 244112 126189 228694 148676 203757 1506023 1552378 125717 271816 288562 203249 231511 187564 230080 146738 258563 133339 283366 169129 298379 190056 252518 268593 104522 509237 1797140 1028272 243677 170374 254811 132971 269246 156593 257929 154277 236879 168705 216448 248462 169214 197829 234193 208684 228505 151723 1053591 772522 231797 155397 211498 155946 238137 174099 209459 100456 276893 111276 277097 139992 228890 240893 168819 191299 228310 273930 153099 262359 147666 1439397 312195 234598 163318 241564 150828 255058 196565 174182 173630 215443 197010 199874 242895 159078 195737 153601 193409 256676 169961 197151 128015 333301 171738 175473 261793 154585 242021 216435 129019 281148 162806 234358 185323 148272 91281 224897 109625 73887 7913 1820 936 588 675 196282 58704 138895 145089 193594 161824 223745 90153 215074 209480 107824 280062 54930 257682 97859 164607 204213 122809 236735 125889 163175 87685 246356 55239 249208 69655 204880 196377 50134 273343 41850 1550198 210819 147671 124923 174412 142887 177710 207829 113889 236744 68336 111507 230047 79640 262908 123257 84624 254223 58516 203851 164698 131634 194491 94883 159943 199201 62737 218530 113663 142627 223616 88524 154659 176102 81226 196572 129042 164059 164151 147245 175619 158434 128720 244835 109410 142258 221118 50203 156730 98101 16736 127790 531 981 1617 4317 4393 5529 8727 1998 7720 7446 6915 6103 11078 6375 7138 5132 10724 6256 7047 10061 4072 690 7604 2156 6318 4426 7191 7267 8667 11955 1874 75115 232608 12510 116643 2826 926 569 1443 2345 3573 6414 8273 7711 9036 990 1902 868 999 825 942 602 736 511 879 864 787 4773 2139 5162 6872 5831 4148 3181 7090 3860 12949 8317 10154 11344 8488 5589 10066 5829 8005 8389 8440 5425 6711 4555 715 835 20374 703 3472 4795 6758 5720 7292 5290 7552 6007 7790 12790 5252 7210 8613 13881 10360 11471 10361 8388 7247 5847 7040 7578 6612 5191 6310 6783 4878 2032 4597 3632 5763 5836 6443 11139 7515 5621 6816 7988 1482 7186 6210 8364 7051 7945 1965 3238 850 644 773 617 882 881 580 1970 824 557 37477 434 654 538621 87526 178473 164214 108217 8609 771 986 49491 9411 21786 1277474 72631 17275 699845 1310975 211796 208194 1374772 1203697 246829 746814 1775778 758069 1353477 755468 462846 1177661 1918945 1153 169069 138956 243130 18772 240596 72186 198670 147395 106195 170766 282940 2506691 92272 237358 122008 141262 168544 117540 167555 129478 119295 179787 171230 214590 78936 155844 224397 90553 159194 144728 196166 131311 217994 1704150 1266913 114925 138491 157557 55151 198556 115494 164224 165847 87549 260793 28872 205867 117546 196634 135758 172002 155142 82712 278622 10501 247362 113566 171101 184704 158172 146713 221435 100376 198366 115639 193518 191393 225962 105240 239628 41258 128438 124390 80169 204516 152418 106625 215549 152035 180643 170560 134653 99214 6930 851 1127 1520 1622 6255 3891 7028 5285 6075 11023 7001 7019 1510 1026 391146 760691 174238 141804 180746 64292 266647 116186 181856 146551 62539 344 706 659 404 1729 1088 5589 2001 6051 5835 11579 12141 5052 7525 15136 5593 10623 7457 8777 9913 8487 10179 6626 8174 8104 9663 8008 11465 8853 8522 10131 7640 9443 7097 8420 6520 5724 7377 5627 1729 6865 2480 210431 1185376 197126 152823 32243 3772 3345 7447 6632 3101 829 518 2152 3302 8677 8620 9392 5765 6141 9404 8641 8555 4954 5727 8084 6921"
, "254470 907642 454834 194716 460560 208333 937483 564906 227871 274756 885330 333777 711283 178890 188198 731938 228193 198227 222813 749740 214310 204954 207685 473006 197828 181143 211642 455290 220501 202975 198919 194160 214064 204642 164408 83628 51437 172629 180519 155858 147259 165068 422380 160143 160902 161472 153182 156030 152235 139417 156023 156731 108577 27047 5673 7583 7259 4917 6774 66812 24481 5663 2759 723 1888 5039 8474 8263 7394 5436 5607 7886 9063 8663 6546 4384 7339 5819 6307 1225 1027 115549 109408 16489 675640 649057 1077921 745935 142728 181193 619918 140482 160077 163008 687059 133050 141457 165561 154868 154851 165867 160696 137986 165082 48555 4063 7281 265722 153935 78399 1894 7521 8786 8963 8115 9322 7441 4815 355600 4859 3095 7865 7192"
, "63617 504438 484648 551286 331805 346273 270868 267144 202529 126029 164066 227123 155730 140187 11891 25746 2758 7292 6998 6733 3594 229271 653910 275418 281143 160287 128080 107750 24150 8460 92092"
, "25447 511643 375737 255394 156860 182685 41586 5125 5826 433384 206628 102361 41852"
, "12723 443690 206127 112135 5475 320006 72107"]

class LocalTunnelDataParser:
    def parse(string_data):
        str_nums = string_data.split(" ")
        nums = []
        size = len(str_nums)
        i = 0
        while i < size:
            nums.append(int(str_nums[i]))
            i += 1
        return nums


class Chart:
    def __init__(self, chart_data, title):
        self.chart_data = chart_data
        self.title = title

    def paint(self, picture_saved_name):
        raise Exception("Chart doesn't implement this function.")

# from matplotlib import pyplot as plt
# #设置x
# x=range(0,8)
# #设置y
# y=[14,17,19,11,14,13,15,16]
# #plot函数需要两个参数，一个是x一个是y
# plt.plot(x,y)
# plt.show()
class LineChart(Chart):
    def __init__(self, chart_data, title):
        Chart.__init__(self, chart_data, title)

    def paint(self, picture_saved_name):
        x0 = range(0, len(self.chart_data[0]))
        x1 = range(0, len(self.chart_data[1]))
        y0 = self.chart_data[0]
        y1 = self.chart_data[1]
        # print(x)
        # print(y0)
        plt.plot(x0, y0, label="local tunnel v1")
        plt.plot(x1, y1, label="local tunnel v2")
        plt.xlabel("sampling")
        plt.ylabel("push time/ns")
        plt.title(self.title)
        plt.grid(alpha=0.5)
        plt.legend()
        plt.savefig(picture_saved_name, dpi=300,format="png")
        # plt.show()


class QueryInfo:
    def __init__(self, id, times):
        self.id = id
        self.times = times

    def addTime(self, time):
        self.times.append(time)

    def getAverageTime(self):
        time_sum = 0
        for time in self.times:
            time_sum += time
        return time_sum / len(self.times)

    def getMinTime(self):
        min_time = 9999999999
        for time in self.times:
            if time < min_time:
                min_time = time
        return min_time

    def getInfoAvg(self):
        return "Q%d: %f" % (self.id, self.getAverageTime())

    def getInfoMin(self):
        return "Q%d: %f" % (self.id, self.getMinTime())
    
    def getAllInfo(self):
        return "Q%d: %.2f %.2f" % (self.id, self.getMinTime(), self.getAverageTime())

def printQueryInfosAvg(infos):
    sum = 0
    for info in infos:
        print(info.getInfoAvg())
        sum += info.getAverageTime()
    print("Sum: %f" % sum)

def printQueryInfosMin(infos):
    sum = 0
    for info in infos:
        print(info.getInfoMin())
        sum += info.getMinTime()
    print("Sum: %f" % sum)

def analyzeTiUPTPCH(file_name):
    with open(file_name, 'r') as f:
        lines = f.readlines()
        analyzeTiUPTPCHImpl(lines)

def analyzeTiUPTPCHImpl(lines):
    for data in lines:
        data = data[11:] # remove "[Current] Q"
        data = data[:-2] # remove the last 's\n' characters
        info = data.split()
        info[0] = info[0][:-1]
        q_num = int(info[0])
        time = float(info[1])
        if q_num in tiup_tpch_results:
            tiup_tpch_results[q_num].addTime(time)
        else:
            tiup_tpch_results[q_num] = QueryInfo(q_num, [time])

def printTiUPResults():
    min_sum = 0
    avg_sum = 0
    for value in tiup_tpch_results.values():
        print(value.getAllInfo())
        min_sum = min_sum + value.getMinTime()
        avg_sum = avg_sum + value.getAverageTime()
    print("Sum: %.2f %.2f" % (min_sum, avg_sum))

def analyzeCHBench():
    with open(file, 'r') as f:
        data = f.readlines()
        if len(data) != query_num:
            exit(-1)
        analyzeCHBenchImpl(data)

def analyzeCHBenchImpl(data):
    query_id = 0
    for item in data:
        query_id += 1
        time = ""
        times = []
        for char in item:
            if char == '[':
                continue
            elif char == ',':
                times.append(float(time))
                time = ""
            elif char == ']':
                times.append(float(time))
                time = ""
                break
            else:
                time += char
        ch_results.append(QueryInfo(query_id, times))

def paint(index):
    v1_data_list = LocalTunnelDataParser.parse(v1_data[index])
    v2_data_list = LocalTunnelDataParser.parse(v2_data[index])

    title = "interval %d" % interval[index]
    line_chart = LineChart([v1_data_list, v2_data_list], title)
    line_chart.paint("%s.png" % title)

if __name__ == "__main__":
    analyzeTiUPTPCH("tmp")
    printTiUPResults()

    # analyze ClickHouse bench data
    # analyzeCHBench()
    # printQueryInfosMin(results)
